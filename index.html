<!DOCTYPE html>
<html lang="fr" class="scroll-smooth antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO & Identity -->
    <title>Laforêt Saint-Avertin | Estimation DVF & Marché Local</title>
    <meta name="description" content="Obtenez la valeur réelle de votre bien basée sur les données DVF de l'État et les ventes récentes à Saint-Avertin. Estimation en ligne immédiate.">
    
    <!-- Favicons & App Icons (Standard Google/Apple) -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/PJbhCjdD/logo-devant-flocage.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/PJbhCjdD/logo-devant-flocage.png">
    <link rel="shortcut icon" type="image/png" href="https://i.postimg.cc/PJbhCjdD/logo-devant-flocage.png">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Estimation DVF - Laforêt Saint-Avertin">
    <meta property="og:description" content="Accédez aux prix réels des ventes notaires dans votre rue.">
    <meta property="og:image" content="https://i.postimg.cc/PJbhCjdD/logo-devant-flocage.png">
    <meta property="og:type" content="website">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-11283228533"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'AW-11283228533');
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        laforet: {
                            navy: '#183C89', // Primary Brand
                            cyan: '#00AFED', // Action
                            bg: '#F5F5F7',   // Apple Surface
                        }
                    },
                    boxShadow: {
                        'apple': '0 4px 24px -1px rgba(0, 0, 0, 0.04)',
                        'apple-hover': '0 8px 32px -4px rgba(0, 0, 0, 0.08)',
                        'glow': '0 0 20px rgba(0, 175, 237, 0.25)',
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'marquee': 'marquee 40s linear infinite',
                        'breathing-glow': 'breathing-glow 3s ease-in-out infinite',
                    },
                    keyframes: {
                        marquee: {
                            '0%': { transform: 'translateX(0%)' },
                            '100%': { transform: 'translateX(-50%)' },
                        },
                        'breathing-glow': {
                            '0%, 100%': { 
                                boxShadow: '0 4px 15px rgba(24, 60, 137, 0.3)',
                                transform: 'scale(1)' 
                            },
                            '50%': { 
                                boxShadow: '0 0 25px rgba(0, 175, 237, 0.6), 0 0 10px rgba(24, 60, 137, 0.2)',
                                transform: 'scale(1.02)' 
                            },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0?dev",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?dev",
            "framer-motion": "https://esm.sh/framer-motion@10.16.4?dev&deps=react@18.2.0,react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0?dev&deps=react@18.2.0"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        *::-webkit-scrollbar { display: none; }
        * { scrollbar-width: none; -ms-overflow-style: none; }
        html, body {
            background-color: #F5F5F7;
            color: #183C89;
            overflow-y: scroll;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .map-blur-bg {
            background-image: url('https://i.postimg.cc/qMVcnC6Y/Generated-Image-December-31-2025-11-37AM.jpg');
            background-size: cover;
            background-position: center;
            filter: blur(8px);
            -webkit-filter: blur(8px);
        }
        /* Utilities for horizontal scroll */
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Marquee Utils */
        .pause-on-hover:hover, .pause-on-hover:active {
            animation-play-state: paused;
        }
        .mask-gradient-x {
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }

        /* Custom Chart Bars */
        .bar-container {
            position: relative;
            height: 12px;
            background: #e5e7eb;
            border-radius: 99px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            border-radius: 99px;
            transition: width 1s ease-out;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- SKELETON SCREEN -->
        <div class="min-h-screen bg-[#F5F5F7] flex flex-col">
            <div class="h-14 md:h-20 bg-white border-b border-gray-200 flex items-center justify-between px-6 sticky top-0 z-50">
                <div class="w-24 h-8 bg-gray-200 rounded skeleton"></div>
            </div>
            <div class="flex-1 flex flex-col items-center justify-center p-6 space-y-6">
                <div class="w-3/4 h-12 bg-gray-300 rounded-lg skeleton"></div>
                <div class="w-1/2 h-6 bg-gray-200 rounded skeleton"></div>
            </div>
        </div>
    </div>

    <!-- 
      SHADOW FORM NETLIFY 
      Ce formulaire est invisible mais détecté par le bot de build Netlify.
      Il doit contenir EXACTEMENT les mêmes 'name' que ceux envoyés par React.
    -->
    <form name="estimation-dvf" method="POST" data-netlify="true" netlify-honeypot="bot-field" hidden>
        <!-- Netlify System Fields -->
        <input type="hidden" name="form-name" value="estimation-dvf" />
        <input type="hidden" name="bot-field" />
        
        <!-- Contact Identity -->
        <input type="text" name="name" />
        <input type="tel" name="phone" />
        <input type="email" name="email" />

        <!-- Property Location -->
        <input type="text" name="address" />
        <input type="text" name="city" />
        <input type="text" name="zipcode" />
        <input type="text" name="street" />

        <!-- Property Specs -->
        <input type="text" name="type" />
        <input type="text" name="surface" />
        <input type="text" name="rooms" />

        <!-- Features (Arrays converted to strings) -->
        <textarea name="boosters"></textarea>
        <textarea name="flaws"></textarea>
    </form>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { motion, AnimatePresence } from 'framer-motion';
        import { 
            Phone, MapPin, Home, Building2, ArrowRight, CheckCircle2, 
            Users, Star, TrendingUp, CalendarClock, ChevronRight, 
            Database, Search, Check, AlertCircle, Loader2, Lock, FileBarChart,
            Download, BarChart3, ShieldCheck, FileText, Smartphone, X, ArrowLeft
        } from 'lucide-react';

        // --- DATA ---
        const googleReviews = [
            {
                author: "Francis DUPONT",
                rating: 5,
                comment: "Nous avons contacté l’agence Laforêt de Saint-Avertin afin d’obtenir une estimation de notre bien immobilier. Malgré cela nous avons obtenu un RDV très rapide. Et avons reçu Vincent, qui s’est montré très professionnel."
            },
            {
                author: "Claude ADR",
                rating: 5,
                comment: "Très bonne rencontre avec l'agence pour un avis de valeur. Le premier contact téléphonique a été très sympathique, suivi d'une rencontre très chaleureuse et professionnelle."
            },
            {
                author: "Ugo Clerici",
                rating: 5,
                comment: "Une agence familiale, réactive, disponible et à l'écoute du besoin du client. Des visites et contre-visites ont été réalisées avec Vincent, Adrien et Olivier."
            },
            {
                author: "Christophe Fontaine",
                rating: 5,
                comment: "Une belle équipe familiale dynamique, sympathique et hyper efficace. Deux biens vendus rapidement en quelques semaines et « au prix ». Bravo à tous !"
            },
            {
                author: "Seb Decout",
                rating: 5,
                comment: "Nous tenons à remercier chaleureusement l'agence LaFORÊT. Olivier a su nous guider avec une connaissance approfondie du terrain, Vincent a été d’une réactivité sans faille."
            },
            {
                author: "Céline M",
                rating: 5,
                comment: "Une entreprise familiale extraordinaire : ils ont réussi à vendre mon appartement en moins d’une semaine alors que seul j’ai attendu pratiquement un an."
            }
        ];

        // --- COMPONENTS ---
        
        // MODAL COMPONENT
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 sm:p-6">
                    <div 
                        className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" 
                        onClick={onClose}
                    />
                    <motion.div 
                        initial={{ opacity: 0, scale: 0.95 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 0.95 }}
                        className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden relative z-10 flex flex-col"
                    >
                        <div className="sticky top-0 bg-white border-b border-gray-100 px-6 py-4 flex items-center justify-between z-20 shrink-0">
                            <h3 className="text-xl font-bold text-laforet-navy">{title}</h3>
                            <button 
                                onClick={onClose} 
                                className="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-gray-900"
                            >
                                <X size={24} />
                            </button>
                        </div>
                        <div className="p-6 md:p-8 text-gray-700 space-y-6 text-sm md:text-base leading-relaxed overflow-y-auto">
                            {children}
                        </div>
                    </motion.div>
                </div>
            );
        };

        const Navbar = () => (
            <motion.nav 
                initial={{ y: -100 }}
                animate={{ y: 0 }}
                className="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-sm md:bg-white shadow-sm border-b border-gray-100"
            >
                <div className="max-w-7xl mx-auto px-4 md:px-6 h-16 md:h-20 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        {/* Logo - Taille réduite sur mobile */}
                        <img src="https://i.postimg.cc/PJbhCjdD/logo-devant-flocage.png" alt="Laforêt" className="h-6 md:h-10 w-auto object-contain" />
                         <div className="hidden md:flex flex-col">
                            <span className="text-sm font-bold text-laforet-navy tracking-tight">AGENCE LaFORÊT</span>
                            <span className="text-xs text-gray-500 font-medium">Saint-Avertin & Larçay</span>
                        </div>
                    </div>
                    {/* Desktop Button */}
                    <a href="tel:0246466380" className="hidden md:flex items-center gap-2 px-5 py-2.5 rounded-full bg-laforet-navy text-white font-bold text-sm shadow-md hover:bg-opacity-90">
                        <Phone size={18} />
                        <span>02 46 46 63 80</span>
                    </a>
                    {/* Mobile Button - Minimal Round Navy Blue */}
                    <a href="tel:0246466380" className="md:hidden w-10 h-10 rounded-full bg-laforet-navy text-white flex items-center justify-center shadow-md hover:bg-opacity-90 active:scale-95 transition-transform">
                        <Phone size={20} />
                    </a>
                </div>
            </motion.nav>
        );

        const Methodology = ({ isMobile }) => {
            if (isMobile) {
                return null;
            }

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8 w-full max-w-4xl mx-auto px-4">
                    <div className="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-xl flex items-center md:items-start gap-4 text-left">
                        <div className="bg-white text-laforet-navy p-2 rounded-lg shrink-0"><Database size={24} /></div>
                        <div>
                            <h4 className="font-bold text-white text-sm">Source A : DVF</h4>
                            <p className="text-white/80 text-xs leading-snug">Données officielles de l'État (Notaires).</p>
                        </div>
                    </div>
                    <div className="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-xl flex items-center md:items-start gap-4 text-left">
                        <div className="bg-white text-laforet-navy p-2 rounded-lg shrink-0"><Building2 size={24} /></div>
                        <div>
                            <h4 className="font-bold text-white text-sm">Source B : Agence</h4>
                            <p className="text-white/80 text-xs leading-snug">Ventes récentes Laforêt dans votre rue.</p>
                        </div>
                    </div>
                    <div className="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-xl flex items-center md:items-start gap-4 text-left">
                        <div className="bg-white text-laforet-navy p-2 rounded-lg shrink-0"><Check size={24} /></div>
                        <div>
                            <h4 className="font-bold text-white text-sm">Source C : Vos Atouts</h4>
                            <p className="text-white/80 text-xs leading-snug">Rénovations et options valorisantes.</p>
                        </div>
                    </div>
                </div>
            );
        };

        const Hero = ({ onStart }) => (
            <section className="relative min-h-screen md:min-h-[700px] flex flex-col items-center justify-center overflow-hidden">
                <div className="absolute inset-0 z-0">
                    <img src="https://i.postimg.cc/qMVcnC6Y/Generated-Image-December-31-2025-11-37AM.jpg" alt="Terrasse" className="w-full h-full object-cover object-center" />
                    {/* DESKTOP OVERLAY */}
                    <div className="hidden md:block absolute inset-0 bg-black/50" />
                    {/* MOBILE OVERLAY - Stronger Contrast */}
                    <div className="md:hidden absolute inset-0 bg-gradient-to-b from-black/60 via-black/50 to-black/90" />
                </div>

                {/* Visible ONLY on Desktop - Mobile is handled by FormEngine Step 0 to allow scroll */}
                <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="hidden md:flex relative z-20 w-full max-w-5xl mx-auto px-4 text-center flex-col justify-center h-full pt-20 pb-20">
                    <div className="inline-flex items-center justify-center gap-2 bg-laforet-cyan/20 backdrop-blur-sm border border-laforet-cyan/30 rounded-full px-4 py-1.5 mb-6 mx-auto">
                        <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        <span className="text-white text-xs font-bold tracking-wide uppercase">Données Ventes 2025/2026 à jour</span>
                    </div>

                    <h1 className="text-5xl font-extrabold text-white tracking-tight leading-tight mb-6 drop-shadow-xl">
                        Quelle est la valeur réelle de votre bien selon les <span className="text-laforet-cyan">dernières ventes de l'État</span> ?
                    </h1>

                    <p className="text-xl text-gray-200 max-w-2xl mx-auto mb-10 font-normal leading-relaxed">
                        Accédez instantanément à une estimation basée sur les transactions réelles de votre rue à Saint-Avertin ou Larçay.
                    </p>

                    <Methodology isMobile={false} />
                </motion.div>
            </section>
        );

        // --- CUSTOM ADDRESS COMPONENT ---
        const AddressAutocomplete = ({ onSelect, mobileMode = false, placeholder }) => {
            const [query, setQuery] = useState("");
            const [suggestions, setSuggestions] = useState([]);
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            useEffect(() => {
                if (query.length > 3) {
                    const fetchAddress = async () => {
                        try {
                            const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
                            const data = await response.json();
                            setSuggestions(data.features || []);
                            setIsOpen(true);
                        } catch (e) {
                            console.error("Erreur API Adresse", e);
                        }
                    };
                    const timeoutId = setTimeout(fetchAddress, 300);
                    return () => clearTimeout(timeoutId);
                } else {
                    setSuggestions([]);
                    setIsOpen(false);
                }
            }, [query]);

            const handleSelect = (feature) => {
                setQuery(feature.properties.label);
                setIsOpen(false);
                onSelect({
                    fullAddress: feature.properties.label,
                    city: feature.properties.city,
                    zipcode: feature.properties.postcode,
                    street: feature.properties.name,
                    coordinates: feature.geometry.coordinates
                });
            };

            return (
                <div ref={wrapperRef} className="relative group w-full">
                    {/* Search Icon */}
                    <Search className={`absolute left-4 top-1/2 -translate-y-1/2 transition-colors ${mobileMode ? 'text-gray-500' : 'text-gray-400 group-focus-within:text-laforet-cyan'}`} size={20} />
                    <input 
                        type="text" 
                        placeholder={placeholder || (mobileMode ? "Entrez votre adresse ici..." : "Saisissez votre adresse...")} 
                        className={`w-full pl-11 pr-4 bg-white outline-none transition-all ${
                            mobileMode 
                            ? 'py-4 rounded-xl text-base font-bold text-gray-800 shadow-xl border-0 ring-4 ring-black/5' 
                            : 'py-5 border-0 md:border md:border-gray-200 rounded-xl text-lg font-medium focus:ring-4 focus:ring-laforet-cyan/20 focus:border-laforet-cyan shadow-xl md:shadow-lg'
                        }`}
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        autoFocus={false}
                    />
                    
                    {isOpen && suggestions.length > 0 && (
                        <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-2xl border border-gray-100 z-50 overflow-hidden max-h-64 overflow-y-auto text-left">
                            {suggestions.map((s, i) => (
                                <div 
                                    key={i} 
                                    className="p-4 hover:bg-blue-50 cursor-pointer flex items-center gap-4 border-b border-gray-50 last:border-0 transition-colors"
                                    onClick={() => handleSelect(s)}
                                >
                                    <div className="bg-gray-100 p-2.5 rounded-full text-gray-500">
                                        <MapPin size={20} />
                                    </div>
                                    <div className="text-left">
                                        <p className="text-base font-bold text-gray-900">{s.properties.name}</p>
                                        <p className="text-sm text-gray-500">{s.properties.postcode} {s.properties.city}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const FormEngine = () => {
            const [step, setStep] = useState(0); 
            const [data, setData] = useState({ 
                address: '', city: '', zipcode: '', street: '', type: 'Maison', surface: '', rooms: '', 
                boosters: [], flaws: [], name: '', phone: '', email: '' 
            });
            const [isSimulatingCalc, setIsSimulatingCalc] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [loadingText, setLoadingText] = useState("Connexion serveur...");
            const [resultData, setResultData] = useState(null);

            const handleAddressSelect = (addressData) => {
                setData({
                    ...data,
                    address: addressData.fullAddress,
                    city: addressData.city,
                    zipcode: addressData.zipcode,
                    street: addressData.street
                });
            };

            const triggerCalc = () => {
                setIsSimulatingCalc(true);
                setTimeout(() => setIsSimulatingCalc(false), 600);
            };

            const toggleItem = (list, item) => {
                const newList = data[list].includes(item) 
                    ? data[list].filter(i => i !== item) 
                    : [...data[list], item];
                setData({ ...data, [list]: newList });
                triggerCalc();
            };

            const next = () => {
                setStep(s => s + 1);
                // Scroll top on next step for better UX
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            
            const prev = () => {
                if (step > 0) setStep(s => s - 1);
                 window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // --- ALGORITHME D'ESTIMATION (Logic preserved) ---
            const calculateEstimation = () => {
                const addressStr = (data.address + " " + data.city).toLowerCase();
                let neighborhood = 'st_avertin_default';

                if (addressStr.includes('larçay') || addressStr.includes('larcay')) {
                    neighborhood = 'larcay';
                } else if (addressStr.includes('cangé') || addressStr.includes('cange') || addressStr.includes('aubinière')) {
                    neighborhood = 'cange';
                } else if (addressStr.includes('onze arpents') || addressStr.includes('11 arpents')) {
                    neighborhood = 'onze_arpents';
                } else if (addressStr.includes('grand village') || addressStr.includes('cigognes')) {
                    neighborhood = 'grand_village';
                } else if (addressStr.includes('vieux') || addressStr.includes('bourg')) {
                    neighborhood = 'vieux_st_avertin';
                }

                const priceMatrix = {
                    cange: { maison: 2985, appt: 2618 },
                    grand_village: { maison: 2700, appt: 2369 },
                    onze_arpents: { maison: 2700, appt: 2539 },
                    vieux_st_avertin: { maison: 2800, appt: 2400 },
                    larcay: { maison: 2400, appt: 2220 },
                    st_avertin_default: { maison: 2850, appt: 2450 }
                };

                const typeKey = data.type === 'Appartement' ? 'appt' : 'maison';
                const basePriceM2 = priceMatrix[neighborhood][typeKey];

                let totalSurface = parseInt(data.surface) || 0;
                let weightedPrice = basePriceM2 * totalSurface;

                let qualityCoeff = 0;
                if (data.boosters.includes("Terrasse / Balcon")) qualityCoeff += 0.05;
                if (data.boosters.includes("Jardin sans vis-à-vis")) qualityCoeff += 0.08;
                if (data.boosters.includes("Calme absolu")) qualityCoeff += 0.05;
                if (data.boosters.includes("Proche Commerces")) qualityCoeff += 0.03;
                if (data.boosters.includes("DPE A/B/C")) qualityCoeff += 0.05;
                
                let fixedBonus = 0;
                if (data.boosters.includes("Garage / Parking")) fixedBonus += 15000;

                let vetusteCoeff = 0;
                if (data.flaws.includes("Travaux à prévoir")) vetusteCoeff += 0.10;
                if (data.flaws.includes("Rue passante")) vetusteCoeff += 0.05; 
                if (data.flaws.includes("Rez-de-chaussée (Appt)")) vetusteCoeff += 0.05;
                if (data.flaws.includes("Électricité ancienne")) vetusteCoeff += 0.05;
                
                if (data.flaws.includes("Travaux à prévoir") && data.flaws.includes("Électricité ancienne")) {
                    vetusteCoeff += 0.10; 
                }

                let estimatedPrice = (weightedPrice * (1 + qualityCoeff) * (1 - vetusteCoeff)) + fixedBonus;

                let confidenceIndex = 2; 
                let rangePercentage = 0.08; 

                if (data.flaws.includes("Travaux à prévoir") || neighborhood === 'cange') {
                    rangePercentage = 0.12; 
                }

                const low = Math.round((estimatedPrice * (1 - rangePercentage)) / 1000) * 1000;
                const high = Math.round((estimatedPrice * (1 + rangePercentage)) / 1000) * 1000;

                return {
                    low,
                    high,
                    avgM2: Math.round(estimatedPrice / totalSurface),
                    confidence: confidenceIndex,
                    neighborhoodLabel: neighborhood.replace(/_/g, ' ').toUpperCase()
                };
            };

            // Animation Step 4
            useEffect(() => {
                if (step === 4) {
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.random() * 15;
                        if (progress > 100) {
                            progress = 100;
                            clearInterval(interval);
                            setTimeout(() => setStep(5), 500);
                        }
                        setLoadingProgress(Math.min(progress, 100));
                    }, 300);
                    return () => clearInterval(interval);
                }
            }, [step]);

            // Animation Step 6
            useEffect(() => {
                if (step === 6) {
                    const texts = [
                        "Connexion Base DVF...",
                        "Analyse des micro-quartiers...",
                        "Calcul des coefficients...",
                        "Finalisation..."
                    ];
                    let i = 0;
                    const interval = setInterval(() => {
                        setLoadingText(texts[i]);
                        i++;
                        if (i >= texts.length) i = texts.length - 1;
                    }, 800); 

                    const timeout = setTimeout(() => {
                        const results = calculateEstimation();
                        setResultData(results);
                        setStep(7);
                        // Results page: ensure top of page
                         window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 3500);

                    return () => {
                        clearInterval(interval);
                        clearTimeout(timeout);
                    };
                }
            }, [step]);

            const handleSubmit = (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                
                // Prepare payload for Netlify (x-www-form-urlencoded)
                const payload = {
                    "form-name": "estimation-dvf",
                    ...data,
                    // Flatten arrays to strings to ensure they are readable in Netlify Forms UI
                    boosters: data.boosters.join(', '),
                    flaws: data.flaws.join(', ')
                };

                const encode = (data) => {
                    return Object.keys(data)
                        .map(key => encodeURIComponent(key) + "=" + encodeURIComponent(data[key]))
                        .join("&");
                };

                fetch("/", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: encode(payload)
                })
                .then(() => {
                    if (window.gtag) window.gtag('event', 'conversion', { 'send_to': 'AW-11283228533/la_CCNLGi9sbEPXOoYQq' });
                    // IMPORTANT: Move to next step only after successful submission or at least after the attempt
                    setStep(6); 
                })
                .catch(err => {
                    console.error("Erreur envoi formulaire:", err);
                    // Fallback: move to next step anyway so user is not blocked
                    setStep(6);
                })
                .finally(() => {
                    setIsSubmitting(false);
                });
            };

            const BoostersList = ["Cuisine récente", "Terrasse / Balcon", "Jardin sans vis-à-vis", "Garage / Parking", "Calme absolu", "Proche Commerces", "DPE A/B/C"];
            const FlawsList = ["Travaux à prévoir", "Vis-à-vis important", "Rue passante", "Rez-de-chaussée (Appt)", "Électricité ancienne", "Isolation à revoir"];

            return (
                <section id="simulator" className={`
                    /* DESKTOP: Integrated card style */
                    md:relative md:z-30 ${step === 0 ? 'md:-mt-32 md:pb-24' : 'md:-mt-10 md:pb-20'}
                    
                    /* MOBILE: */
                    /* Step 0: Transparent overlay allowing scroll to other sections */
                    ${step === 0 ? 'absolute top-0 inset-x-0 min-h-screen z-20 flex flex-col justify-end pb-12' : ''}
                    /* Step 1+: Scrollable Page Section "Sous le hero" style with Padding for Fixed Navbar */
                    ${step > 0 ? 'absolute top-0 inset-x-0 z-40 bg-[#F5F5F7] min-h-screen flex flex-col pt-16 md:pt-0' : ''}
                `}>
                    <div className={`
                        ${step > 0 ? 'min-h-full flex flex-col' : ''}
                        md:max-w-xl md:mx-auto md:bg-white md:rounded-2xl md:shadow-2xl md:shadow-laforet-navy/20 md:overflow-hidden md:border md:border-gray-100 md:block
                        w-full
                    `}>
                        
                        {/* HEADER DU CARD (Desktop: Progress Bar / Mobile Step>0: Context Header) */}
                        {step > 0 && step < 7 && (
                            <>
                                {/* DESKTOP HEADER */}
                                <div className="hidden md:block sticky top-0 bg-white z-10">
                                    <div className="flex bg-gray-50 border-b border-gray-100 px-6 py-4 items-center justify-between shrink-0">
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs font-bold text-laforet-navy uppercase tracking-wider">Étape {step}/5</span>
                                        </div>
                                        <button onClick={prev} className="text-gray-400 hover:text-laforet-navy transition-colors"><ArrowLeft size={16}/></button>
                                    </div>
                                    <div className="w-full bg-gray-100 h-1">
                                        <motion.div 
                                            className="bg-laforet-cyan h-full" 
                                            initial={{ width: 0 }} 
                                            animate={{ width: `${(step / 5) * 100}%` }} 
                                        />
                                    </div>
                                </div>

                                {/* MOBILE HEADER (Contextual) */}
                                <div className="md:hidden bg-white px-4 py-4 shadow-sm border-b border-gray-100 sticky top-16 z-30">
                                    <div className="flex items-center justify-between mb-2">
                                        <button onClick={prev} className="flex items-center gap-1 text-gray-400 text-sm font-medium"><ArrowLeft size={16}/> Retour</button>
                                        <span className="text-xs font-bold text-laforet-cyan uppercase tracking-wider">Étape {step}/5</span>
                                    </div>
                                    <div className="flex items-center gap-2 text-laforet-navy font-bold text-sm truncate">
                                        <MapPin size={14} className="shrink-0" />
                                        <span className="truncate">{data.address || "Votre bien"}</span>
                                    </div>
                                     <div className="w-full bg-gray-100 h-1 mt-3 rounded-full overflow-hidden">
                                        <motion.div 
                                            className="bg-laforet-cyan h-full rounded-full" 
                                            initial={{ width: 0 }} 
                                            animate={{ width: `${(step / 5) * 100}%` }} 
                                        />
                                    </div>
                                </div>
                            </>
                        )}

                        <div className={`
                            md:p-8 relative flex-grow
                            ${step === 0 ? 'px-4' : 'px-4 py-6 md:p-6'}
                        `}>
                            <AnimatePresence mode="wait">
                                {step === 0 && (
                                    <motion.div key="step0" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className="w-full">
                                        
                                        {/* MOBILE HERO CONTENT - UPDATED CRO DESIGN */}
                                        <div className="md:hidden flex flex-col items-center text-center justify-center h-full pt-24 pb-8">
                                            
                                            {/* Surtitre Pill */}
                                            <div className="bg-white px-4 py-1.5 rounded-full mb-6 shadow-lg border border-gray-100">
                                                <span className="text-laforet-navy text-xs font-bold uppercase tracking-widest">Saint-Avertin & Larçay</span>
                                            </div>

                                            {/* H1 - Massive Impact */}
                                            <h1 className="text-[2.6rem] font-extrabold text-white leading-none mb-4 drop-shadow-lg">
                                                Quelle est la valeur <span className="text-laforet-cyan">ACTUELLE</span> de votre bien ?
                                            </h1>

                                            {/* Subtitle */}
                                            <p className="text-gray-100 text-lg leading-snug mb-8 font-medium drop-shadow-md opacity-95 px-2">
                                                Obtenez votre fourchette de prix instantanée basée sur les ventes réelles du quartier.
                                            </p>

                                            {/* MAGNETIC INPUT UNIT */}
                                            <div className="w-full space-y-3 bg-black/20 backdrop-blur-md p-4 rounded-3xl border border-white/20 shadow-2xl">
                                                <AddressAutocomplete 
                                                    onSelect={handleAddressSelect} 
                                                    mobileMode={true} 
                                                    placeholder="Commencez par saisir votre adresse..." 
                                                />
                                                <button onClick={next} disabled={!data.address} className="w-full bg-laforet-navy text-white font-bold h-[56px] rounded-xl disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-all flex justify-center gap-2 items-center text-lg shadow-xl uppercase tracking-wide">
                                                    Estimer Gratuitement <ChevronRight size={24} strokeWidth={3} />
                                                </button>
                                            </div>
                                        </div>

                                        {/* DESKTOP CONTENT (Optimized) */}
                                        <div className="text-center space-y-1 hidden md:block mb-6">
                                            <p className="text-xs font-bold text-laforet-cyan uppercase tracking-wider mb-2">Estimation Intelligente</p>
                                            <h3 className="text-2xl font-bold text-laforet-navy">Commençons par situer précisément votre bien</h3>
                                            <p className="text-gray-500 text-sm">Analyse comparative des ventes DVF 2025 à Saint-Avertin.</p>
                                        </div>
                                        
                                        <div className="hidden md:block mt-6 mb-6">
                                            <AddressAutocomplete onSelect={handleAddressSelect} />
                                        </div>
                                        {data.address && (
                                            <motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} className="hidden md:flex bg-blue-50 border border-blue-100 rounded-xl p-4 items-center gap-3 mb-6">
                                                <div className="bg-white p-2 rounded-full text-green-500 shadow-sm"><CheckCircle2 size={20} /></div>
                                                <div>
                                                    <p className="font-bold text-laforet-navy text-sm">{data.address}</p>
                                                    <p className="text-xs text-blue-600">Adresse localisée avec succès</p>
                                                </div>
                                            </motion.div>
                                        )}
                                        <button onClick={next} disabled={!data.address} className="hidden md:flex w-full bg-laforet-navy text-white font-bold py-5 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg active:scale-95 transition-all justify-center gap-2 items-center text-lg shadow-xl border border-white/20 md:border-0">
                                            Commencer <ArrowRight size={24} />
                                        </button>
                                    </motion.div>
                                )}

                                {step === 1 && (
                                    <motion.div key="step1" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }} className="flex flex-col h-full gap-8 max-w-lg mx-auto">
                                        <div className="md:text-center pt-2">
                                            <h3 className="text-2xl font-bold text-laforet-navy">Type de bien</h3>
                                            <p className="text-gray-500 text-sm mt-1">S'agit-il d'une maison ou d'un appartement ?</p>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 gap-4">
                                            <button onClick={() => setData({...data, type: 'Maison'})} className={`p-6 rounded-2xl border-2 flex flex-row items-center justify-start gap-6 transition-all shadow-sm ${data.type === 'Maison' ? 'border-laforet-cyan bg-cyan-50/50 text-laforet-navy' : 'border-gray-100 bg-white text-gray-500'}`}>
                                                <div className="bg-gray-50 p-3 rounded-full shadow-sm border border-gray-100"><Home size={32} strokeWidth={1.5} className="text-laforet-navy" /></div>
                                                <div className="text-left">
                                                    <span className="font-bold text-xl block">Maison Individuelle</span>
                                                    <span className="text-sm text-gray-400">Villa, Pavillon...</span>
                                                </div>
                                            </button>
                                            <button onClick={() => setData({...data, type: 'Appartement'})} className={`p-6 rounded-2xl border-2 flex flex-row items-center justify-start gap-6 transition-all shadow-sm ${data.type === 'Appartement' ? 'border-laforet-cyan bg-cyan-50/50 text-laforet-navy' : 'border-gray-100 bg-white text-gray-500'}`}>
                                                <div className="bg-gray-50 p-3 rounded-full shadow-sm border border-gray-100"><Building2 size={32} strokeWidth={1.5} className="text-laforet-navy" /></div>
                                                <div className="text-left">
                                                    <span className="font-bold text-xl block">Appartement</span>
                                                    <span className="text-sm text-gray-400">Copropriété, Duplex...</span>
                                                </div>
                                            </button>
                                        </div>
                                        
                                        <div className="mt-auto md:mt-0">
                                            <button onClick={next} disabled={!data.type} className="w-full bg-laforet-navy text-white font-bold h-[60px] rounded-xl disabled:opacity-50 transition-all text-lg shadow-lg flex items-center justify-center gap-2">
                                                Suivant <ArrowRight size={20}/>
                                            </button>
                                        </div>
                                    </motion.div>
                                )}

                                {step === 2 && ( // Changed Step 2 to Surface/Rooms to match flow description "Type, Surfaces, Détails"
                                     <motion.div key="stepSurface" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }} className="flex flex-col h-full gap-8 max-w-lg mx-auto">
                                        <div className="md:text-center pt-2">
                                            <h3 className="text-2xl font-bold text-laforet-navy">Dimensions</h3>
                                            <p className="text-gray-500 text-sm mt-1">Surface habitable et nombre de pièces.</p>
                                        </div>

                                        <div className="bg-white rounded-2xl md:shadow-none shadow-sm border border-gray-100 md:border-0 p-6 md:p-0 space-y-8">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Surface Habitable (m²)</label>
                                                <div className="relative">
                                                    <input type="number" inputMode="numeric" pattern="[0-9]*" value={data.surface} onChange={(e) => setData({...data, surface: e.target.value})} className="w-full p-5 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-laforet-cyan font-bold text-3xl text-center text-laforet-navy placeholder-gray-300" placeholder="0" autoFocus />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Nombre de Pièces</label>
                                                <div className="flex flex-wrap justify-between gap-2">
                                                    {[1,2,3,4,5].map(num => (
                                                        <button key={num} onClick={() => setData({...data, rooms: num})} className={`flex-1 h-14 rounded-xl font-bold text-xl transition-all border-2 ${data.rooms == num ? 'bg-laforet-navy text-white border-laforet-navy shadow-lg' : 'bg-white border-gray-100 text-gray-600'}`}>
                                                            {num}
                                                        </button>
                                                    ))}
                                                    <button onClick={() => setData({...data, rooms: 6})} className={`flex-1 h-14 rounded-xl font-bold text-xl transition-all border-2 ${data.rooms >= 6 ? 'bg-laforet-navy text-white border-laforet-navy shadow-lg' : 'bg-white border-gray-100 text-gray-600'}`}>6+</button>
                                                </div>
                                            </div>
                                        </div>

                                        <button onClick={next} disabled={!data.surface} className="mt-4 md:mt-auto w-full bg-laforet-navy text-white font-bold h-[60px] rounded-xl disabled:opacity-50 transition-all text-lg shadow-lg flex items-center justify-center gap-2">
                                            Suivant <ArrowRight size={20}/>
                                        </button>
                                     </motion.div>
                                )}

                                {step === 3 && ( // Previously Step 2 (Boosters)
                                    <motion.div key="step3" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }} className="flex flex-col h-full max-w-lg mx-auto">
                                        <div className="md:text-center mb-6 pt-2">
                                            <h3 className="text-2xl font-bold text-laforet-navy">Les Atouts</h3>
                                            <p className="text-sm text-gray-500 mt-1">Sélectionnez les points forts de votre bien.</p>
                                        </div>
                                        
                                        <div className="flex-1 overflow-y-visible">
                                            <div className="grid grid-cols-1 gap-3">
                                                {BoostersList.map(item => (
                                                    <button key={item} onClick={() => toggleItem('boosters', item)} className={`flex items-center justify-between p-4 rounded-xl border-2 transition-all text-left ${data.boosters.includes(item) ? 'border-green-500 bg-green-50 text-green-900 font-bold shadow-md' : 'border-transparent bg-white shadow-sm text-gray-600'}`}>
                                                        <span className="text-base">{item}</span>
                                                        {data.boosters.includes(item) ? <CheckCircle2 size={24} className="text-green-500" /> : <div className="w-6 h-6 rounded-full border-2 border-gray-200 bg-white" />}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        <button onClick={next} className="w-full bg-laforet-navy text-white font-bold h-[60px] rounded-xl transition-all text-lg shadow-lg mt-8 shrink-0 flex items-center justify-center gap-2">
                                            Valider ces atouts <ArrowRight size={20}/>
                                        </button>
                                    </motion.div>
                                )}

                                {step === 4 && ( // Previously Step 3 (Flaws)
                                     <motion.div key="step4" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }} className="flex flex-col h-full max-w-lg mx-auto">
                                        <div className="md:text-center mb-6 pt-2">
                                            <h3 className="text-2xl font-bold text-laforet-navy">Points d'attention</h3>
                                            <p className="text-sm text-gray-500 mt-1">Ces éléments peuvent impacter l'estimation.</p>
                                        </div>
                                        
                                        <div className="flex-1 overflow-y-visible">
                                            <div className="grid grid-cols-1 gap-3">
                                                {FlawsList.map(item => (
                                                    <button key={item} onClick={() => toggleItem('flaws', item)} className={`flex items-center justify-between p-4 rounded-xl border-2 transition-all text-left ${data.flaws.includes(item) ? 'border-amber-500 bg-amber-50 text-amber-900 font-bold shadow-md' : 'border-transparent bg-white shadow-sm text-gray-600'}`}>
                                                        <span className="text-base">{item}</span>
                                                        {data.flaws.includes(item) ? <AlertCircle size={24} className="text-amber-500" /> : <div className="w-6 h-6 rounded-full border-2 border-gray-200 bg-white" />}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        <button onClick={next} className="w-full bg-laforet-navy text-white font-bold h-[60px] rounded-xl transition-all text-lg shadow-lg mt-8 shrink-0 flex items-center justify-center gap-2">
                                            Lancer le calcul <ChevronRight size={24} strokeWidth={3}/>
                                        </button>
                                    </motion.div>
                                )}

                                {step === 5 && ( // Contact
                                    <motion.div key="step5" initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="flex flex-col h-full justify-start md:justify-center text-center px-2 max-w-lg mx-auto pt-8 md:pt-0">
                                        <div className="mb-8 pt-4">
                                            <div className="inline-flex items-center gap-2 bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-bold mb-4">
                                                <CheckCircle2 size={18} /> Calcul terminé
                                            </div>
                                            <h3 className="text-2xl font-bold text-laforet-navy">Votre rapport est prêt</h3>
                                            <p className="text-gray-500 mt-2">Où pouvons-nous vous l'envoyer ?</p>
                                        </div>
                                        
                                        <div className="space-y-4 w-full">
                                            <div className="relative">
                                                <Users className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={20}/>
                                                <input type="text" placeholder="Nom complet" className="w-full pl-12 p-5 bg-white border border-gray-200 rounded-xl outline-none focus:border-laforet-navy text-lg font-medium shadow-sm" value={data.name} onChange={(e) => setData({...data, name: e.target.value})} />
                                            </div>
                                            <div className="relative">
                                                <Smartphone className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={20}/>
                                                <input type="tel" inputMode="tel" placeholder="Mobile (pour le SMS)" className="w-full pl-12 p-5 bg-white border border-gray-200 rounded-xl outline-none focus:border-laforet-navy text-lg font-medium shadow-sm" value={data.phone} onChange={(e) => setData({...data, phone: e.target.value})} />
                                            </div>
                                            <div className="relative">
                                                <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">@</div>
                                                <input type="email" inputMode="email" placeholder="Email" className="w-full pl-12 p-5 bg-white border border-gray-200 rounded-xl outline-none focus:border-laforet-navy text-lg font-medium shadow-sm" value={data.email} onChange={(e) => setData({...data, email: e.target.value})} />
                                            </div>
                                        </div>

                                        <button 
                                            onClick={handleSubmit} 
                                            disabled={!data.name || !data.phone || !data.email || isSubmitting} 
                                            className="w-full bg-laforet-navy text-white font-bold h-[60px] rounded-xl shadow-xl hover:bg-laforet-navy/90 transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-wait text-lg mt-8"
                                        >
                                            {isSubmitting ? <Loader2 className="animate-spin" size={24} /> : "Voir mon estimation"}
                                        </button>
                                        
                                        <div className="mt-6 flex justify-center gap-6 text-xs text-gray-400">
                                            <span className="flex items-center gap-1"><ShieldCheck size={12}/> Données sécurisées</span>
                                            <span className="flex items-center gap-1"><Lock size={12}/> Pas de spam</span>
                                        </div>
                                    </motion.div>
                                )}

                                {step === 6 && ( // Loader
                                    <motion.div key="step6" initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex flex-col items-center justify-center text-center h-full min-h-[50vh]">
                                        <Loader2 className="animate-spin text-laforet-cyan mb-6" size={64} />
                                        <h3 className="text-2xl font-bold text-laforet-navy mb-4 animate-pulse">{loadingText}</h3>
                                        <p className="text-gray-400 text-sm">Veuillez patienter quelques secondes...</p>
                                    </motion.div>
                                )}

                                {step === 7 && resultData && ( // Result
                                    <motion.div key="step7" initial={{ opacity: 0, y: 50 }} animate={{ opacity: 1, y: 0 }} className="pb-40 pt-12 md:pb-32 md:pt-8">
                                        
                                        <div className="text-center mb-8">
                                            <div className="inline-block bg-green-100 text-green-700 px-4 py-1.5 rounded-full text-xs font-bold mb-4 uppercase tracking-wide">
                                                Marché 2026 : {resultData.neighborhoodLabel}
                                            </div>
                                            <h3 className="text-3xl font-bold text-laforet-navy mb-1">Estimation Finale</h3>
                                            <p className="text-gray-500 text-sm">Basée sur {data.surface}m² à {data.city || 'Saint-Avertin'}</p>
                                        </div>

                                        {/* PRICE CARD */}
                                        <div className="bg-gradient-to-br from-laforet-navy to-[#2a4d9e] p-8 rounded-3xl text-white text-center shadow-2xl shadow-blue-900/20 mb-8 relative overflow-hidden">
                                            <div className="absolute top-0 right-0 p-4 opacity-10"><TrendingUp size={120} /></div>
                                            <p className="text-blue-200 text-sm font-bold mb-3 uppercase tracking-wider">Fourchette Net Vendeur</p>
                                            <div className="text-[40px] font-extrabold tracking-tight mb-4 leading-none">
                                                {Math.round(resultData.low / 1000)}k€ - {Math.round(resultData.high / 1000)}k€
                                            </div>
                                            <div className="inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full text-xs font-bold border border-white/10">
                                                <div className="flex gap-0.5">
                                                    {[...Array(5)].map((_, i) => (
                                                        <Star key={i} size={12} className={i < resultData.confidence ? "fill-yellow-400 text-yellow-400" : "text-blue-200/50"} />
                                                    ))}
                                                </div>
                                                <span>Indice de Confiance : {resultData.confidence}/5</span>
                                            </div>
                                        </div>

                                        <p className="text-center text-xs text-gray-400 leading-relaxed px-6 mb-8">
                                            *Cette fourchette est purement indicative et calculée sur des données déclaratives. Seule une visite technique permet de valider le prix final.
                                        </p>

                                        {/* STICKY MOBILE CTA (Step 7 only) */}
                                        <div className="md:hidden fixed bottom-6 left-4 right-4 z-[100] pb-[env(safe-area-inset-bottom)]">
                                            <a href="tel:0246466380" className="w-full bg-[#183C89] text-white font-bold h-[64px] rounded-full shadow-2xl flex items-center justify-center gap-3 border border-white/20 text-lg animate-breathing-glow motion-reduce:animate-none hover:scale-105 transition-transform">
                                                <Phone size={24} /> Appeler mon expert
                                            </a>
                                        </div>
                                    </motion.div>
                                )}

                            </AnimatePresence>
                        </div>
                    </div>
                </section>
            );
        };

        const TeamCard = ({ photo, name, role, desc }) => (
            <div className="flex gap-4 p-5 rounded-2xl bg-white border border-gray-100 shadow-sm min-w-[300px] snap-center">
                <img src={photo} alt={name} className="w-16 h-16 object-cover rounded-xl flex-shrink-0" />
                <div>
                    <h4 className="text-lg font-bold text-laforet-navy leading-none mb-1">{name}</h4>
                    <p className="text-xs font-bold text-laforet-cyan uppercase mb-2">{role}</p>
                    <p className="text-sm text-gray-500 leading-snug line-clamp-3">{desc}</p>
                </div>
            </div>
        );

        const TeamSection = () => (
            <section className="py-12 md:py-16 px-4 bg-[#F5F5F7]">
                <div className="max-w-7xl mx-auto">
                    <div className="mb-8 text-center">
                        <h2 className="text-2xl md:text-4xl font-bold text-laforet-navy mb-2">L'équipe locale</h2>
                        <p className="text-gray-500 text-sm">Des experts de Saint-Avertin à vos côtés.</p>
                    </div>
                    {/* Mobile: Horizontal Scroll / Desktop: Grid */}
                    <div className="flex overflow-x-auto gap-4 pb-4 md:grid md:grid-cols-2 md:gap-4 md:overflow-visible no-scrollbar snap-x snap-mandatory px-4 -mx-4 md:px-0 md:mx-0">
                        <TeamCard name="Olivier" role="Franchisé" photo="https://i.postimg.cc/qvCXZQ65/LF2025-26-2.jpg" desc="30 ans de direction dans le bâtiment. Sécurise les dossiers techniques." />
                        <TeamCard name="Vincent" role="Agent Commercial" photo="https://i.postimg.cc/k4h2C3kz/LF2025-18.jpg" desc="Expert en négociation internationale. Maximise le net vendeur." />
                        <TeamCard name="Hélène" role="Agent Commercial" photo="https://i.postimg.cc/PfRDsYj9/LF2025-24-2.jpg" desc="30 ans d'expérience bancaire. Valide les financements acquéreurs." />
                        <TeamCard name="Adrien" role="Agent Commercial" photo="https://i.postimg.cc/ThvY2RQD/LF2025-20-2.jpg" desc="Spécialiste marketing digital. Sublime votre bien." />
                    </div>
                </div>
            </section>
        );

        const LocalInfluenceSection = ({ onCtaClick }) => {
            const [activeCardIndex, setActiveCardIndex] = useState(0);

            const observatoryCards = [
                {
                    icon: TrendingUp,
                    title: "Prix au m²",
                    content: (
                        <div className="space-y-3 mb-6 flex-grow">
                            <div className="flex justify-between items-baseline border-b border-gray-50 pb-2">
                                <span className="text-gray-600 font-medium">Saint-Avertin</span>
                                <span className="text-lg font-bold text-laforet-navy">~2 950 €</span>
                            </div>
                            <div className="flex justify-between items-baseline">
                                <span className="text-gray-600 font-medium">Larçay</span>
                                <span className="text-lg font-bold text-laforet-navy">~2 650 €</span>
                            </div>
                        </div>
                    )
                },
                {
                    icon: CalendarClock,
                    title: "Tension",
                    content: (
                        <div className="space-y-3 mb-6 flex-grow">
                            <div className="flex justify-between items-center border-b border-gray-50 pb-2">
                                <span className="text-gray-600 font-medium">Délai moyen</span>
                                <span className="text-lg font-bold text-laforet-navy">89j</span>
                            </div>
                            <div className="flex justify-between items-center pt-2">
                                <span className="text-gray-600 font-medium">Demande</span>
                                <span className="text-[10px] font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full uppercase">Forte</span>
                            </div>
                        </div>
                    )
                },
                {
                    icon: Users,
                    title: "Acheteurs",
                    content: (
                        <div className="space-y-3 mb-6 flex-grow">
                            <p className="text-sm text-gray-700">Familles & Cadres cherchent maisons 4-6 pièces avec jardin.</p>
                            <p className="text-xs text-gray-400 mt-2">Revenu médian > 38k€/an</p>
                        </div>
                    )
                }
            ];

            const nextCard = () => {
                setActiveCardIndex((prev) => (prev + 1) % observatoryCards.length);
            };

            return (
                <section className="py-12 md:py-24 px-4 bg-[#F5F5F7] border-t border-gray-100">
                    <div className="max-w-7xl mx-auto">
                        <div className="text-center mb-8 md:mb-16">
                            <h2 className="text-2xl md:text-4xl font-extrabold text-laforet-navy mb-3 leading-tight">
                                Observatoire du Marché
                            </h2>
                            <p className="text-sm md:text-lg text-gray-600 max-w-2xl mx-auto">
                                La réalité du marché local au 1er Janvier 2026.
                            </p>
                        </div>

                        {/* MOBILE: TAP CAROUSEL (DECK) */}
                        <div className="md:hidden px-2 relative min-h-[300px]">
                            <AnimatePresence mode="wait">
                                <motion.div
                                    key={activeCardIndex}
                                    initial={{ opacity: 0, x: 20 }}
                                    animate={{ opacity: 1, x: 0 }}
                                    exit={{ opacity: 0, x: -20, transition: { duration: 0.15 } }}
                                    transition={{ duration: 0.2 }}
                                    className="w-full bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex flex-col cursor-pointer active:scale-[0.98] transition-transform select-none"
                                    onClick={nextCard}
                                >
                                    <div className="flex items-center gap-3 mb-4">
                                        <div className="p-2.5 bg-blue-50 text-laforet-navy rounded-xl">
                                            {React.createElement(observatoryCards[activeCardIndex].icon, { size: 20 })}
                                        </div>
                                        <h3 className="font-bold text-laforet-navy text-lg">{observatoryCards[activeCardIndex].title}</h3>
                                    </div>
                                    
                                    {observatoryCards[activeCardIndex].content}

                                    {/* Footer / Hint */}
                                    <div className="mt-4 pt-4 border-t border-gray-50 flex justify-between items-center text-xs text-gray-400">
                                        <span className="font-medium">Touchez pour voir la suite</span>
                                        <div className="flex items-center gap-2">
                                            <span className="uppercase tracking-widest font-bold text-gray-300">{activeCardIndex + 1}/{observatoryCards.length}</span>
                                            <div className="bg-gray-50 p-1.5 rounded-full text-laforet-cyan"><ArrowRight size={12}/></div>
                                        </div>
                                    </div>
                                </motion.div>
                            </AnimatePresence>
                        </div>

                        {/* DESKTOP: ORIGINAL GRID (Unchanged) */}
                        <div className="hidden md:grid md:grid-cols-3 md:gap-8">
                            {/* CARD 1 */}
                            <div className="bg-white rounded-2xl p-6 md:p-8 shadow-sm border border-gray-100 flex flex-col">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2.5 bg-blue-50 text-laforet-navy rounded-xl"><TrendingUp size={20} /></div>
                                    <h3 className="font-bold text-laforet-navy text-lg">Prix au m²</h3>
                                </div>
                                <div className="space-y-3 mb-6 flex-grow">
                                    <div className="flex justify-between items-baseline border-b border-gray-50 pb-2">
                                        <span className="text-gray-600 font-medium">Saint-Avertin</span>
                                        <span className="text-lg font-bold text-laforet-navy">~2 950 €</span>
                                    </div>
                                    <div className="flex justify-between items-baseline">
                                        <span className="text-gray-600 font-medium">Larçay</span>
                                        <span className="text-lg font-bold text-laforet-navy">~2 650 €</span>
                                    </div>
                                </div>
                            </div>
                            {/* CARD 2 */}
                            <div className="bg-white rounded-2xl p-6 md:p-8 shadow-sm border border-gray-100 flex flex-col">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2.5 bg-blue-50 text-laforet-navy rounded-xl"><CalendarClock size={20} /></div>
                                    <h3 className="font-bold text-laforet-navy text-lg">Tension</h3>
                                </div>
                                <div className="space-y-3 mb-6 flex-grow">
                                    <div className="flex justify-between items-center border-b border-gray-50 pb-2">
                                        <span className="text-gray-600 font-medium">Délai moyen</span>
                                        <span className="text-lg font-bold text-laforet-navy">89j</span>
                                    </div>
                                    <div className="flex justify-between items-center pt-2">
                                        <span className="text-gray-600 font-medium">Demande</span>
                                        <span className="text-[10px] font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full uppercase">Forte</span>
                                    </div>
                                </div>
                            </div>
                            {/* CARD 3 */}
                            <div className="bg-white rounded-2xl p-6 md:p-8 shadow-sm border border-gray-100 flex flex-col">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2.5 bg-blue-50 text-laforet-navy rounded-xl"><Users size={20} /></div>
                                    <h3 className="font-bold text-laforet-navy text-lg">Acheteurs</h3>
                                </div>
                                <div className="space-y-3 mb-6 flex-grow">
                                    <p className="text-sm text-gray-700">Familles & Cadres cherchent maisons 4-6 pièces avec jardin.</p>
                                    <p className="text-xs text-gray-400 mt-2">Revenu médian > 38k€/an</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            );
        };

        const GoogleReviewsSection = () => (
            <section className="py-12 md:py-16 bg-white border-t border-gray-100 relative overflow-hidden">
                <div className="text-center mb-10 px-6">
                    <h2 className="text-2xl md:text-3xl font-bold text-laforet-navy mb-2">Avis Clients</h2>
                    <div className="flex items-center justify-center gap-2 text-amber-500">
                        <div className="flex">
                            {[...Array(5)].map((_, i) => <Star key={i} className="w-5 h-5 fill-current" />)}
                        </div>
                        <span className="text-laforet-navy font-bold text-sm">4.9/5 sur Google</span>
                    </div>
                </div>

                {/* MOBILE: INFINITE MARQUEE */}
                <div className="md:hidden relative w-full overflow-hidden mask-gradient-x">
                    <div className="absolute inset-y-0 left-0 w-8 bg-gradient-to-r from-white to-transparent z-10 pointer-events-none"></div>
                    <div className="absolute inset-y-0 right-0 w-8 bg-gradient-to-l from-white to-transparent z-10 pointer-events-none"></div>
                    
                    <div className="flex w-max animate-marquee pause-on-hover">
                        {[...googleReviews, ...googleReviews].map((review, index) => (
                            <div key={index} className="w-[85vw] max-w-[300px] p-6 mx-3 bg-[#F9FAFB] rounded-2xl border border-gray-100 flex flex-col justify-between shrink-0 select-none">
                                <div>
                                    <div className="flex gap-0.5 mb-3 text-amber-400">
                                        {[...Array(5)].map((_, i) => <Star key={i} size={14} className="fill-current" />)}
                                    </div>
                                    <p className="text-gray-600 text-sm italic mb-4 leading-relaxed">"{review.comment}"</p>
                                </div>
                                <p className="font-bold text-laforet-navy text-xs uppercase">{review.author}</p>
                            </div>
                        ))}
                    </div>
                </div>

                {/* DESKTOP: ORIGINAL GRID (Unchanged) */}
                <div className="hidden md:grid md:grid-cols-3 md:gap-8 md:overflow-visible no-scrollbar px-4 pb-8 max-w-7xl mx-auto">
                    {googleReviews.map((review, index) => (
                        <div key={index} className="flex-shrink-0 w-auto p-6 bg-[#F9FAFB] rounded-2xl border border-gray-100 flex flex-col justify-between">
                            <div>
                                <div className="flex gap-0.5 mb-3 text-amber-400">
                                    {[...Array(5)].map((_, i) => <Star key={i} size={14} className="fill-current" />)}
                                </div>
                                <p className="text-gray-600 text-sm italic mb-4 leading-relaxed">"{review.comment}"</p>
                            </div>
                            <p className="font-bold text-laforet-navy text-xs uppercase">{review.author}</p>
                        </div>
                    ))}
                </div>
                
                <div className="text-center mt-8">
                     <a 
                        href="https://share.google/MfdTpW9PIsacXfgmq" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-2 text-laforet-cyan font-bold text-sm hover:underline"
                    >
                        Lire tous les avis Google <ArrowRight size={16} />
                    </a>
                </div>
            </section>
        );

        const App = () => {
            const [showLegal, setShowLegal] = useState(false);
            const [showPrivacy, setShowPrivacy] = useState(false);
            
            const scrollToForm = () => {
                const el = document.getElementById('simulator');
                if(el) {
                     window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            return (
                <div className="min-h-screen bg-[#F5F5F7] overflow-x-hidden relative">
                    <Navbar />
                    <Hero onStart={scrollToForm} />
                    <FormEngine />
                    
                    {/* Content below fold - visible when scrolling on Step 0 */}
                    <TeamSection />
                    <LocalInfluenceSection onCtaClick={scrollToForm} />
                    <GoogleReviewsSection />
                    
                    <footer className="bg-white py-8 border-t border-gray-100">
                        <div className="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="text-center md:text-left">
                                <p className="text-xs text-gray-400">&copy; 2026 Laforêt Saint-Avertin (IMMO SUD TOURAINE).</p>
                                <p className="text-[10px] text-gray-300 mt-0.5">Données DVF mises à jour.</p>
                            </div>
                            <div className="flex items-center justify-center gap-6">
                                <button onClick={() => setShowLegal(true)} className="text-xs text-gray-400 hover:text-laforet-navy transition-colors">Mentions Légales</button>
                                <button onClick={() => setShowPrivacy(true)} className="text-xs text-gray-400 hover:text-laforet-navy transition-colors">Politique de Confidentialité</button>
                            </div>
                        </div>
                    </footer>

                    <AnimatePresence>
                        {showLegal && (
                            <Modal isOpen={showLegal} onClose={() => setShowLegal(false)} title="Mentions Légales">
                                <section>
                                    <h4 className="font-bold text-gray-900 mb-2 text-lg">1. Éditeur du site</h4>
                                    <div className="space-y-1 bg-gray-50 p-4 rounded-xl border border-gray-100">
                                        <p><strong>Société :</strong> IMMO SUD TOURAINE (SAS au capital de 10 000 €)</p>
                                        <p><strong>Siège social :</strong> 35 Rue du Général Mocquery, 37550 Saint-Avertin</p>
                                        <p><strong>SIRET :</strong> 947 858 163 00019 | <strong>RCS :</strong> Tours 947 858 163</p>
                                        <p><strong>Directeur de publication :</strong> M. Olivier PETIT</p>
                                        <p><strong>Contact :</strong> saint-avertin@laforet.com</p>
                                    </div>
                                </section>
                                <section>
                                    <h4 className="font-bold text-gray-900 mb-2 text-lg">2. Activité réglementée</h4>
                                    <div className="space-y-1">
                                        <p><strong>Titre professionnel :</strong> Agent Immobilier</p>
                                        <p><strong>Carte Pro :</strong> CPI 3701 2023 0000 00004 (CCI Indre-et-Loire)</p>
                                        <p><strong>Assurance RCP :</strong> GALIAN - SMABTP (Contrat n° K00448B9970000)</p>
                                        <p><strong>Garantie Financière :</strong> GALIAN Assurances</p>
                                    </div>
                                </section>
                                <section>
                                    <h4 className="font-bold text-gray-900 mb-2 text-lg">3. Hébergement</h4>
                                    <p><strong>Netlify, Inc.</strong><br/>2325 3rd Street, Suite 296, San Francisco, California 94107, USA.</p>
                                </section>
                            </Modal>
                        )}
                        {showPrivacy && (
                            <Modal isOpen={showPrivacy} onClose={() => setShowPrivacy(false)} title="Politique de Confidentialité (RGPD)">
                                 <section>
                                    <h4 className="font-bold text-gray-900 mb-2 text-lg">1. Collecte et Finalité</h4>
                                    <p className="mb-2">Les informations recueillies sur ce formulaire sont enregistrées dans un fichier informatisé par <strong>IMMO SUD TOURAINE (M. Olivier PETIT)</strong>.</p>
                                    <p>Elles sont destinées exclusivement à :</p>
                                    <ul className="list-disc pl-5 mt-2 space-y-1 marker:text-laforet-cyan">
                                        <li>L'élaboration de votre estimation immobilière personnalisée.</li>
                                        <li>L'envoi de la fiche analytique du marché local.</li>
                                        <li>La prise de contact commerciale par l'agence Laforêt Saint-Avertin.</li>
                                    </ul>
                                </section>
                                <section>
                                    <h4 className="font-bold text-gray-900 mb-2 text-lg">2. Durée de conservation</h4>
                                    <p>Vos données sont conservées pendant une durée de <strong>3 ans</strong> à compter de votre dernier contact avec notre agence.</p>
                                </section>
                                <section>
                                    <h4 className="font-bold text-gray-900 mb-2 text-lg">3. Vos Droits</h4>
                                    <p className="mb-2">Conformément au Règlement Général sur la Protection des Données (RGPD), vous pouvez exercer votre droit d'accès, de rectification, d'effacement et d'opposition aux données vous concernant.</p>
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-blue-900">
                                        <p className="font-bold text-sm">Contact DPO / Exercice des droits :</p>
                                        <a href="mailto:saint-avertin@laforet.com" className="text-laforet-navy font-bold underline">saint-avertin@laforet.com</a>
                                    </div>
                                </section>
                            </Modal>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>